# BookWise Development Environment
# Usage: docker-compose up -d

version: '3.8'

services:
  # PostgreSQL Database
  bookwise-db:
    image: postgres:15-alpine
    container_name: bookwise-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: bookwise_db
      POSTGRES_USER: bookwise_user
      POSTGRES_PASSWORD: bookwise_pass
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=fr_FR.UTF-8 --lc-ctype=fr_FR.UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - bookwise-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bookwise_user -d bookwise_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  bookwise-redis:
    image: redis:7-alpine
    container_name: bookwise-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass redis_pass
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - bookwise-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis_pass", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend API
  bookwise-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: bookwise-api
    restart: unless-stopped
    environment:
      # Database
      DATABASE_URL: "postgresql://bookwise_user:bookwise_pass@bookwise-db:5432/bookwise_db"
      
      # Redis
      REDIS_URL: "redis://:redis_pass@bookwise-redis:6379"
      
      # JWT
      JWT_SECRET: "your-super-secret-jwt-key-change-in-production"
      JWT_REFRESH_SECRET: "your-super-secret-refresh-key-change-in-production"
      JWT_EXPIRES_IN: "1h"
      JWT_REFRESH_EXPIRES_IN: "7d"
      
      # Application
      NODE_ENV: "development"
      PORT: "8000"
      
      # CORS
      CORS_ORIGIN: "http://localhost:5173,http://localhost:3000"
      
      # Features
      ENABLE_SWAGGER: "true"
      ENABLE_RATE_LIMITING: "true"
      
      # Email (configure with your SMTP)
      EMAIL_HOST: "smtp.gmail.com"
      EMAIL_PORT: "587"
      EMAIL_SECURE: "false"
      EMAIL_USER: "your-email@gmail.com"
      EMAIL_PASSWORD: "your-app-password"
    ports:
      - "8000:8000"
    depends_on:
      bookwise-db:
        condition: service_healthy
      bookwise-redis:
        condition: service_healthy
    networks:
      - bookwise-network
    volumes:
      - ./backend/logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend (React)
  bookwise-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: bookwise-web
    restart: unless-stopped
    environment:
      VITE_API_URL: "http://localhost:8000"
      VITE_APP_NAME: "BookWise"
      VITE_BUILD_MODE: "development"
    ports:
      - "5173:5173"
    depends_on:
      - bookwise-backend
    networks:
      - bookwise-network
    volumes:
      - ./frontend:/app
      - /app/node_modules

# Named volumes for data persistence
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

# Network for service communication
networks:
  bookwise-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16